<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ConnectHub - Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="/css/HERO_CSS/hero.css">

    <style>
        .feed {
            max-width: 700px;
            margin: 40px auto;
        }

        .post-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .post-content {
            margin: 15px 0;
            line-height: 1.6;
            color: #333;
        }

        .post-image {
            width: 100%;
            border-radius: 12px;
            margin: 15px 0;
            max-height: 500px;
            object-fit: cover;
        }

        .post-actions {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #764ba2;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s;
            border: none;
            background: transparent;
        }

        .action-btn:hover {
            background: #f5f5f5;
        }

        .action-btn.liked {
            color: #e91e63;
        }

        .action-btn.liked .like-icon {
            fill: #e91e63;
        }

        .like-icon {
            width: 20px;
            height: 20px;
        }

        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .comment-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .comment-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
        }

        .comment-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg,#667eea,#764ba2);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
        }

        .comment-item {
            padding: 10px;
            margin-top: 10px;
            background: #f9f9f9;
            border-radius: 12px;
        }

        .comment-author {
            font-weight: 600;
            font-size: 13px;
            color: #764ba2;
        }

        .comment-content {
            margin-top: 5px;
            font-size: 14px;
            color: #333;
        }

        .comment-date {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .delete-post-btn {
            background: #f5576c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .delete-post-btn:hover {
            background: #e0485c;
        }
    </style>
</head>

<body>

<!-- ================= NAVBAR ================= -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- ================= WELCOME POPUP ================= -->
<div th:replace="~{fragments/welcome-popup :: welcome-popup}"></div>

<!-- ================= FEED ================= -->
<section class="feed">

    <h3>üì∞ Fil d‚Äôactualit√©</h3>

    <div th:if="${posts.size() == 0}">
        <p>Aucun post pour le moment.</p>
    </div>

    <div th:each="post : ${posts}" class="post-card" th:attr="data-post-id=${post.id}">

        <div class="post-header">
            <div>
                <strong th:text="${post.author.name}">Nom</strong>
                <span style="margin-left: 10px; color: #999;" 
                      th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}">
                    date
                </span>
            </div>
            <button th:if="${post.author.email == username}" 
                    class="delete-post-btn"
                    th:onclick="'deletePost(' + ${post.id} + ')'">
                Supprimer
            </button>
        </div>

        <div class="post-content" th:text="${post.content}">
            Contenu du post
        </div>

        <img th:if="${post.imageUrl != null}" 
             th:src="${post.imageUrl}" 
             class="post-image" 
             alt="Image du post">

        <div class="post-actions">
            <button class="action-btn like-btn" 
                    th:attr="data-post-id=${post.id}"
                    th:onclick="'toggleLike(' + ${post.id} + ')'">
                <svg class="like-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                <span class="like-text">J'aime</span>
                <span class="like-count" th:text="'(' + ${post.likes != null ? post.likes.size() : 0} + ')'">(0)</span>
            </button>
            <button class="action-btn comment-btn" 
                    th:attr="data-post-id=${post.id}"
                    th:onclick="'toggleComments(' + ${post.id} + ')'">
                üí¨ Commenter
                <span class="comment-count" th:text="'(' + ${post.comments != null ? post.comments.size() : 0} + ')'">(0)</span>
            </button>
        </div>

        <div class="comments-section" th:id="'comments-' + ${post.id}" style="display: none;">
            <div class="comment-form">
                <input type="text" 
                       class="comment-input" 
                       th:id="'comment-input-' + ${post.id}"
                       placeholder="√âcrivez un commentaire...">
                <button class="comment-btn" 
                        th:onclick="'addComment(' + ${post.id} + ')'">
                    Envoyer
                </button>
            </div>
            <div th:id="'comments-list-' + ${post.id}">
                <!-- Les commentaires seront charg√©s ici -->
            </div>
        </div>

    </div>

</section>

<!-- ================= CREATE POST ================= -->
<div class="post-card">
    <h3 style="margin-bottom: 15px;">‚úçÔ∏è Cr√©er une publication</h3>
    <form th:action="@{/posts}" method="post" enctype="multipart/form-data">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <textarea name="content"
                  placeholder="Quoi de neuf ?"
                  required
                  style="width:100%;min-height:80px;
                         border-radius:12px;padding:12px;
                         border:1px solid #ddd;resize:none;"></textarea>

        <div style="margin-top: 10px;">
            <label for="image" style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">
                üì∑ Ajouter une image (optionnel)
            </label>
            <input type="file" 
                   id="image" 
                   name="image" 
                   accept="image/*"
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
        </div>

        <button type="submit"
                style="margin-top:10px;
                       padding:10px 20px;
                       border:none;
                       border-radius:10px;
                       background:linear-gradient(135deg,#667eea,#764ba2);
                       color:white;
                       font-weight:600;
                       cursor:pointer;">
            Publier
        </button>
    </form>
</div>

<script>
    // Fonction pour liker/unliker une publication
    function toggleLike(postId) {
        fetch('/posts/' + postId + '/like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const likeBtn = document.querySelector(`.like-btn[data-post-id="${postId}"]`);
                const likeText = likeBtn.querySelector('.like-text');
                const likeCount = likeBtn.querySelector('.like-count');
                
                if (data.liked) {
                    likeBtn.classList.add('liked');
                    likeText.textContent = 'J\'aime';
                } else {
                    likeBtn.classList.remove('liked');
                    likeText.textContent = 'J\'aime';
                }
                likeCount.textContent = '(' + data.likeCount + ')';
            }
        })
        .catch(error => console.error('Erreur:', error));
    }

    // Fonction pour afficher/masquer les commentaires
    function toggleComments(postId) {
        const commentsSection = document.getElementById('comments-' + postId);
        if (commentsSection.style.display === 'none') {
            commentsSection.style.display = 'block';
            loadComments(postId);
        } else {
            commentsSection.style.display = 'none';
        }
    }

    // Fonction pour charger les commentaires
    function loadComments(postId) {
        fetch('/posts/' + postId + '/comments', {
            credentials: 'include'
        })
            .then(response => response.json())
            .then(comments => {
                const commentsList = document.getElementById('comments-list-' + postId);
                commentsList.innerHTML = '';
                
                comments.forEach(comment => {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'comment-item';
                    commentDiv.innerHTML = `
                        <div class="comment-author">${comment.author.name}</div>
                        <div class="comment-content">${comment.content}</div>
                        <div class="comment-date">${new Date(comment.createdAt).toLocaleString('fr-FR')}</div>
                    `;
                    commentsList.appendChild(commentDiv);
                });
            })
            .catch(error => console.error('Erreur:', error));
    }

    // Fonction pour ajouter un commentaire
    function addComment(postId) {
        const input = document.getElementById('comment-input-' + postId);
        const content = input.value.trim();
        
        if (!content) return;

        const formData = new FormData();
        formData.append('content', content);

        fetch('/posts/' + postId + '/comments', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                input.value = '';
                loadComments(postId);
                // Mettre √† jour le compteur de commentaires
                const commentBtn = document.querySelector(`.comment-btn[data-post-id="${postId}"]`);
                const commentCount = commentBtn.querySelector('.comment-count');
                commentCount.textContent = '(' + data.commentCount + ')';
            }
        })
        .catch(error => console.error('Erreur:', error));
    }

    // Fonction pour supprimer une publication
    function deletePost(postId) {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette publication ?')) {
            return;
        }

        fetch('/posts/' + postId, {
            method: 'DELETE',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la suppression');
        });
    }

    // Charger le statut des likes au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        const postCards = document.querySelectorAll('.post-card');
        postCards.forEach(card => {
            const postId = card.getAttribute('data-post-id');
            fetch('/posts/' + postId + '/like-status', {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    const likeBtn = card.querySelector('.like-btn');
                    const likeCount = likeBtn.querySelector('.like-count');
                    
                    if (data.liked) {
                        likeBtn.classList.add('liked');
                    }
                    likeCount.textContent = '(' + data.likeCount + ')';
                })
                .catch(error => console.error('Erreur:', error));
        });
    });
</script>
</body>
</html>